## 🎯 5장. 안정 해시(Consistent Hashing)와 수평 확장 설계

### ✅ 수평적 규모 확장의 필요성

- 서버를 늘려 트래픽을 분산하는 **수평 확장(Scale-out)**을 위해서는, 요청을 서버에 고르게 분배하는 기술이 필수적입니다.
- **안정 해시(Consistent Hashing)**는 서버 수가 변해도 **데이터 재배치가 최소화**되는 기술로 널리 사용됩니다.


### 🚨 기존 해시의 문제점: 해시 키 재배치 문제

### 기본 방식

```
serverIndex = hash(key) % N // N은 서버 수
```

- 서버 수가 4일 때는 `key0 → 서버1`, `key2 → 서버2` 등으로 정상 작동
- 하지만 서버가 **추가/삭제**되면 `N` 값이 변하고 **모든 키의 서버 인덱스가 바뀌게 됨**
→ 대규모 **캐시 미스(cache miss)** 발생 ⚠️


### 🧩 안정 해시(Consistent Hashing)란?

- 서버 수 변화 시에도 전체 키의 **일부만 재배치**되도록 설계된 해시 기법
- 핵심 개념: 해시 공간을 **원형 링**으로 구성하고 키와 서버를 **해시 값에 따라 링에 배치**


### 🔁 해시 링 구조

- SHA-1 등 해시 함수를 사용해 값들을 `0 ~ 2^160-1` 범위로 매핑
- 이 값을 원형으로 구부리면 해시 링이 됨
- 서버와 키는 이 링 상의 위치를 가짐


### 📦 저장 서버 결정 방식

- 키는 링에서 **시계 방향으로 탐색**해 처음 만나는 서버에 저장
- 서버 추가/제거 시 영향받는 키는 해당 **서버 이전 구간의 일부 키들**에 국한됨

### 🔀 가상 노드(Virtual Nodes)로 균형 잡기

### 문제점:

- 일부 서버가 지나치게 많은 키를 가지거나, 일부는 거의 가지지 않는 불균형 발생 가능

### 해결 방법:

- 각 물리적 서버를 **여러 개의 가상 노드**로 분할해 링에 분산 배치
- 예: `S0_0`, `S0_1`, `S0_2` → 모두 서버 0이 관리
- 가상 노드 수가 많아질수록 **키 분포의 표준편차가 작아짐** → 데이터 균등화

### 🔁 서버 추가/삭제 시 재배치 구간

- **서버 추가**: 새 서버 위치부터 **이전 서버 사이의 키들**만 이동
- **서버 제거**: 삭제된 서버 위치부터 **이전 서버 사이의 키들**을 인접 서버가 인계


### 📈 안정 해시의 장점 요약

- ✅ 서버 추가/삭제 시 재배치되는 키 수 최소화
- ✅ 키 분포 균등화 → **수평 확장성 향상**
- ✅ 특정 키 집중 현상(Hotspot) 완화 → **트래픽 집중 방지**

### 🛠️ 실제 사용 예시

안정 해시는 여러 글로벌 시스템에서 널리 채택된 기술입니다.

- Amazon **DynamoDB** 파티셔닝
- Apache **Cassandra** 클러스터링
- **Discord** 채팅 메시지 처리
- **Akamai** CDN
- Maglev 부하 분산 시스템