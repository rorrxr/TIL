## 8장 URL 단축기 시스템 설계
8장에서는 대규모 트래픽을 처리할 수 있는 **URL 단축기 시스템을 설계**합니다. 

단순한 기능처럼 보이지만, 

실제로는 높은 **가용성과 확장성을 고려**해야 하는 복잡한 시스템입니다.

## 1단계 문제 이해 및 설계 범위 확정

### 요구사항 정의

- **기능적 요구사항:**
    - 긴 URL을 짧은 URL로 변환
    - 단축된 URL을 통해 원래 URL로 리디렉션
    - 단축 URL은 영구적으로 유지되며, 삭제나 갱신은 불가능
- **비기능적 요구사항:**
    - **트래픽 규모:** 일일 1억 개의 단축 URL 생성
    - **읽기/쓰기 비율:** 읽기 10 : 쓰기 1
    - **저장 용량:** 10년간 3650억 개의 레코드 저장 (약 36.5TB)
    - **단축 URL 구성:** 숫자와 영문자만 사용, 가능한 한 짧은 길이

## 2단계 개략적 설계안 제시 및 동의 구하기

### API 엔드포인트

1. **URL 단축용 엔드포인트:**
    1. 새 단축 URL을 생성하고자 하는 엔드포인트
    2. 단축 URL을 인자로 실어 POST 요청을 보냄
    3. POST /api/v1/data/shorten
        1. 인자: {longUrl, String}
        2. 반환: 단축 URL
2. **URL 리디렉션 엔드포인트:**
    - 단축 URL에 대해서 원래 URL로 보내주기 위한 엔드포인트
    - GET /api/v1/shortUrl
    - 반환: HTTP 리디렉션 목적지가 될 원래 URL

• 단축 URL을 받은 서버는 원래 URL로 바꾸어서 301 응답의 Location 헤더에 넣어 반환

![image.png](attachment:8718e9af-52de-4665-a46e-b8ccb13e1a9b:image.png)

### **301 응답과 302 응답의 차이**

- **301 Moved Permanently:**
    - 브라우저는 이 응답을 캐시 한다.
    - 추후 같은 단축 URL에 요청을 보낼 필요가 있을때 브라우저는 캐시된 원래 URL로 요청을 보내게 된다.
    - 서버 부하를 줄일 수 있음, 트래픽 분석을 하기 어려움
- **302 Found:**
    - 브라우저는 단축 URL서버에 먼저 보낸후 원래 URL로 리디렉션
    - 트래픽 분석이 필요할 때 사용
    - 서버 부하 받을 수 있음
    

301과 302는 캐싱을 하는지 유무에 따라 사용하면 될 것 같다. 

단축 URL에 대한 원래 URL이 변경될 경우 301 응답을 사용하면 안 된다.

### URL 단축

단축 URL을 생성하기 위해서는 긴 URL을 해시 값으로 대응시킬 해시 함수 fx를 찾는 일

![image.png](attachment:6c19c94f-e41c-46b9-8aa3-3de95385d58f:image.png)

- 해시 함수는 다음 요구사항을 만족 해야 합니다.
    - 입력으로 주어지는 긴 URL이 다른 값이면 해시 값도 달라야 함
    - 계산된 해시 값은 원래 입력으로 주어졌던 긴 URL로 복원될 수 있어야 함

## 3단계 상세 설계

### 데이터 모델링

- **데이터 모델:**
    - 메모리는 유한하기 때문에 <단축 URL, 원래 URL>의 순서쌍을 관계형 데이터베이스에 저장
    - id, shortURL, longURL 세개의 칼럼을 갖는다.

### 해시 함수

원래 URL을 단축URL로 만드는 해시 함수를 만들어야 한다.

- 단축 URLDMS [0-9, a-z, A-Z]의 문자열들로 구성됨
- 사용할 수 있는 문자의 개수는 10(0-9) + 26(a-z) + 26(A-Z) = 62개
- 대략적으로 계산했던 추정치에 따르면 3650억개의 URL을 만들 수 있어야 한다. n=7 이면 3.5조개의 URL을 만들 수 있다. 단축URL의 길이는 7로 설정

### 해시 후 충돌 해소

- 긴 URL을 줄이려면, 원래 URL을 7글자 문자열로 줄이는 해시 함수가 필요함
- 손쉬운 방법으로는 CRC32, MD5, SHA-1 같이 잘 알려진 해시 함수를 이용하는 것
- 문제는 CRC32가 가장 짧지만 7자리를 넘어간다.
- 처음 7개 글자만 사용할 경우 결과가 충돌할 확률이 높아진다.
- 실제 충돌을 하면 충돌을 해소할 때까지 사전에 정한 문자열을 해시값에 덧붙이는 방법이 있다.

![image.png](attachment:6c03fec7-23c5-4b2a-a682-2dc6b7d8572c:image.png)

하지만 이렇게 하면 단축URL을 생성할 때 한 번 이상 데이터베이스에 질의해야하므로 오버헤드의 부담이 생긴다. 

1. **숫자 기반 접근:**
    - 고유한 숫자 ID를 생성하고, 이를 Base62로 인코딩하여 단축 URL 생성
    - 예: ID 125 → Base62 인코딩 → "cb"

### Base62 인코딩

- 진법 변환은 URL 단축기를 구현할 때 흔히 사용되는 접근 방법 중 하나
- 이 기법은 수의 표현 방식이 다른 두 시스템이 같은 수를 공유하여야 하는 경우에 유용하다.
- base-62를 사용하면 단축 URL에 사용할 수 있는 문자 개수가 62개이기 때문
- **사용 문자 집합:** 0-9, a-z, A-Z (총 62개)
- **필요한 길이 계산:**
    - 62^7 ≈ 3.5조 → 7자리로 3650억 개의 URL 커버 가능

![image.png](attachment:f2c88c97-123a-4e84-8c24-71e5ab4675a9:image.png)

### URL 단축기 상세 설계

- URL 단축기 시스템의 처리 흐름
    1. 입력으로 긴 URL을 받는다
    2. 데이터베이스에 해당 URL이 있는지 검사한다.
    3. **데이터베이스에 있다면** 데이터베이스에서 찾은 단축 URL을 변환
    4. **데이터베이스에 없다면** 새로운 ID를 생성
    5. 생선된 ID를 단축 URL로 변환한다.
    6. ID, 단축URL, 원래 URL로 데이터베이스에 저장한다.

### URL 리디렉션 상세 설계

![image.png](attachment:60ffcb9a-28cf-4cef-ac15-72010593b5bd:image.png)

1. 사용자가 단축 URL을 클릭
2. 로드밸런서가 해당 클릭으로 발생한 요청을 웹서버에 전달
3. 단축 URL이 이미 캐시에 있는 경우에는 원래 URL을 바로 꺼내서 반환합니다.
4. 단축 URL이 캐시에 없는 경우에는 데이터베이스에 꺼낸다. 만약 데이터가 없으면 사용자가 잘못된 단축 URL을 입력한 것이다.
5. 데이터베이스에서 꺼낸 URL을 캐시에 넣은 후 사용자에게 반환한다.

## 마무리

URL 단축기 시스템은 단순한 기능처럼 보이지만, 대규모 트래픽을 효율적으로 처리하기 위해서는 다양한 요소를 고려해야 합니다. 

해시 함수 선택, 고유 ID 생성, 캐싱 전략, 리디렉션 방식 등 각 요소에 대한 깊은 이해와 적절한 선택이 필요합니다.

이러한 설계를 통해 높은 가용성과 확장성을 갖춘 URL 단축기 시스템을 구축할 수 있습니다.

- 처리율 제한 장치
    - 엄청난 양의 URL 단축 요청이 밀려오면 무력화 될수도 있다.
    - 처리율 제한 장치를 둬서 요청을 걸러낼 수 있을 것
- 웹 계층은 무상태 계층이므로, 웹 서버를 자유로이 증설하거나 삭제할 수 있음
- 데이터베이스의 규모 확장
    - 데이터베이스를 다중화하거나 샤딩하여 **규모 확장성**을 달성 할 수 있음
- 데이터 분석 솔루션
    - 데이터를 통해 링크를 얼마나 많은 사용자가 클릭했는지, 언제 주로 클릭했는지 등 중요한 정보를 알아낼 수 있을 것이다.