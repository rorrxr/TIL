# 📌 근접성 서비스 (LBS) 시스템 설계

---

## 1. 쿼드트리 운영 시 고려사항

- **초기화 지연**
    - 서버 시작 시 트리 구축 필요 → 서비스 시작 지연 발생
    - 구축 중에는 트래픽 처리 불가
- **배포 전략**
    - Blue/Green Deployment로 테스트 환경 ↔ 실제 환경 전환
    - 점진적 확장(Incremental Build) 활용 가능
- **운영상 이슈**
    - 새 사업장 추가 시 트리 전체 재생성 필요
    - 동시성 문제 발생 가능 → Lock 메커니즘 필요
    - Key 단위 접근 시 캐시 서버 부하 고려 필요

---

## 2. 실제 사용 사례 & 대안 기술

### 2.1 쿼드트리 실제 사례

- 덴버(미국) 지역 적용 사례
- 인구 밀집 지역 → 작은 격자 사용
- 인구 희박 지역 → 큰 격자 사용

### 2.2 구글 S2

- 지구(구체, sphere)를 **힐베르트 곡선(Hilbert Curve)** 으로 매핑 → 1차원 인덱싱
- **특징**
    - 공간 채움 곡선 기반 인덱싱
    - 1차원 검색 → 2차원 검색보다 효율적
- **지오펜스(Geofence) 지원**
    - 특정 반경 km 이내 영역 지정 가능
    - 알림(Notification) 기능 제공 → 단순 근접 검색보다 풍부한 기능

### 2.3 지오해시 vs 쿼드트리

- **지오해시**
    - 구현과 사용 간단 (트리 필요 없음)
    - 격자 크기 고정 → 인구 밀도 따라 조정 불가
    - 복잡한 논리 필요 (예: 특정 값만 제거)
- **쿼드트리**
    - 트리 구축 필요 → 구현 복잡
    - 인구 밀도 따라 **격자 크기 동적 조정 가능**
    - 검색 범위 점진적 확장 가능
    - 하위 노드 분할 과정 필요

---

## 3. 상세 설계 (3단계)

### 3.1 DB 확장성

- **사업장 테이블**
    - 사업장 ID 기준 샤딩(sharding) → 부하 분산
    - 모든 샤드에 균등하게 분산 가능
- **지리 정보 색인 테이블**
    - 지오해시/쿼드트리 기반 색인 사용
    - **두 가지 저장 방식**
        1. 지오해시 → JSON 배열에 모든 사업장 ID 저장
        2. 지오해시 + 사업장 ID → 복합 키(compound key)로 저장
    - 방식 2가 권장됨 → 삭제/추가 용이, Lock 불필요

### 3.2 캐시 설계

- **캐시 키 설계**
    - 사용자 위치(위도·경도) 기반 지오해시 Key
    - 사업장 ID Key
- **특징**
    - 위치 정보는 근사치 → 조금 달라도 안정적
    - 캐시 적중률 높임
- **캐시 데이터 유형**
    - Key: 지오해시, Value: 해당 격자 내 사업장 목록
    - Key: 사업장 ID, Value: 사업장 상세 정보

### 3.3 캐시 활용

- 특정 지오해시에 해당하는 사업장 ID를 Redis에 캐시
- 캐시 조회 순서
    1. 캐시에서 조회
    2. 캐시 미스 → DB 조회 후 캐시에 적재
- 갱신 전략
    - 사업장 정보 변경 시 캐시 무효화(invalidate)
    - 빈도 낮으므로 Lock 불필요

### 3.4 메모리 요구량

- 사업장 개수: 200m개
- 각 사업장당 3개 정밀도 저장 시 약 5GB 필요
- Redis 클러스터링 + 지역별 분산 저장 필요

### 3.5 지역 및 가용성 구역

- 지역별 데이터센터 분산 필요
- 고가용성(HA) 및 낮은 지연(latency) 보장
- 예: 미국 사용자 → 미국 데이터센터, 유럽 사용자 → 유럽 데이터센터

---

## 4. 최종 설계 흐름

1. 클라이언트 → 사용자 위치/검색 반경 전송
2. 로드밸런서 → LBS로 요청 전달
3. LBS → 지오해시/쿼드트리 계산
4. Redis에서 사업장 ID 목록 조회
5. 사업장 ID 기반으로 상세 정보 조회
6. 거리 계산 후 우선순위 정렬 → 클라이언트에 응답

---

## 5. 면접 시 추가 질문 대비

- **추가 기능**
    - 시간대별 검색
    - 업종별 검색
- **설명 포인트**
    - 쿼드트리 vs 지오해시 vs 구글 S2 비교
    - 캐시 활용 전략 (Key 설계, Invalidaton)
    - 다중 데이터센터/지역 분산 설계
    - 개인정보 보호법(Privacy Law) 고려

---

## 6. 요약

- **1단계: 요구사항**
    - 기능적 요구: 사업장 조회/추가/삭제/갱신, 데이터 보호, 5k QPS
    - 비기능적 요구: 낮은 응답 지연
- **2단계: API & 데이터 모델**
    - 검색 API
    - 데이터 샤딩
    - 색인: 지오해시 / 쿼드트리 / S2
- **3단계: 상세 설계**
    - 캐시(Key, Value, 데이터 유형)
    - 지역 및 가용성 구역
    - 결과 필터링
- **4단계: 마무리**
    - 2차원 검색, 균등 분할 격자, 지오해시, 쿼드트리, 구글 S2